(window.webpackJsonp=window.webpackJsonp||[]).push([[79],{552:function(s,e,a){"use strict";a.r(e);var n=a(11),t=Object(n.a)({},(function(){var s=this,e=s.$createElement,a=s._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"在-kubernetes-上运行"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#在-kubernetes-上运行"}},[s._v("#")]),s._v(" 在 Kubernetes 上运行")]),s._v(" "),a("p",[s._v("本文档描述了如何使用我们提供的 specs 来运行 HStreamDB kubernetes。该文档假设读者\n有基本的 kubernetes 知识。在本节结束时，你将拥有一个完全运行在 kubernetes 上的\nHStreamDB 集群，它已经准备就绪，可以接收读/写，处理数据，等等。")]),s._v(" "),a("h2",{attrs:{id:"建立你的-kubernetes-集群"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#建立你的-kubernetes-集群"}},[s._v("#")]),s._v(" 建立你的 Kubernetes 集群")]),s._v(" "),a("p",[s._v("第一步是要有一个正在运行的 kubernetes 集群。你可以使用一个托管的集群（由你的云提\n供商提供），一个自我托管的集群或一个本地的 kubernetes 集群，比如 minikube。请确\n保 kubectl 指向你计划使用的任何集群。")]),s._v(" "),a("p",[s._v('另外，你需要一个名为 "hstream-store "的存储类，你可以通过 "kubectl "创建。或者通\n过你的云服务提供商的网页来创建，如果它有的话。')]),s._v(" "),a("h2",{attrs:{id:"安装-zookeeper"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装-zookeeper"}},[s._v("#")]),s._v(" 安装 Zookeeper")]),s._v(" "),a("p",[s._v("HStreamDB 依赖于 Zookeeper 来存储查询信息和一些内部的存储配置，所以我们需要提供\n一个 Zookeeper 集群，以便 HStreamDB 能够访问。")]),s._v(" "),a("p",[s._v("在这个演示中，我们将使用"),a("a",{attrs:{href:"https://helm.sh/",target:"_blank",rel:"noopener noreferrer"}},[s._v("helm"),a("OutboundLink")],1),s._v("（一个用于 kubernetes 的软件包管\n理器）来安装 zookeeper。安装完 helm 后，运行：")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("helm repo "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" bitnami https://charts.bitnami.com/bitnami\nhelm repo update\n\nhelm "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" zookeeper bitnami/zookeeper "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  --set image.tag"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.6")]),s._v(".3 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  --set "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("replicaCount")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  --set persistence.storageClass"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("hstream-store "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  --set persistence.size"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("20Gi\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('NAME: zookeeper\nLAST DEPLOYED: Tue Jul  6 10:51:37 2021\nNAMESPACE: test\nSTATUS: deployed\nREVISION: 1\nTEST SUITE: None\nNOTES:\n** Please be patient while the chart is being deployed **\n\nZooKeeper can be accessed via port 2181 on the following DNS name from within your cluster:\n\n    zookeeper.svc.cluster.local\n\nTo connect to your ZooKeeper server run the following commands:\n\n    export POD_NAME=$(kubectl get pods -l "app.kubernetes.io/name=zookeeper,app.kubernetes.io/instance=zookeeper,app.kubernetes.io/component=zookeeper" -o jsonpath="{.items[0].metadata.name}")\n    kubectl exec -it $POD_NAME -- zkCli.sh\n\nTo connect to your ZooKeeper server from outside the cluster execute the following commands:\n\n    kubectl port-forward svc/zookeeper 2181:2181 &\n    zkCli.sh 127.0.0.1:2181\nWARNING: Rolling tag detected (bitnami/zookeeper:3.6.3), please note that it is strongly recommended to avoid using rolling tags in a production environment.\n+info https://docs.bitnami.com/containers/how-to/understand-rolling-tags-containers/\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br")])]),a("p",[s._v("这将默认安装一个 3 个节点的 zookeeper 集合。等到所有的节点标记为 Ready。")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("kubectl get pods\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("NAME         READY   STATUS    RESTARTS   AGE\nzookeeper-0  1/1     Running   0          22h\nzookeeper-1  1/1     Running   0          4d22h\nzookeeper-2  1/1     Running   0          16m\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h2",{attrs:{id:"配置和启动-hstreamdb"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置和启动-hstreamdb"}},[s._v("#")]),s._v(" 配置和启动 HStreamDB")]),s._v(" "),a("p",[s._v("一旦所有的 zookeeper pods 都准备好了，我们就可以开始安装 HStreamDB 集群。")]),s._v(" "),a("h3",{attrs:{id:"拿到-k8s-spec"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#拿到-k8s-spec"}},[s._v("#")]),s._v(" 拿到 k8s spec")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" clone git@github.com:hstreamdb/hstream.git\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" hstream/deploy/k8s\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h3",{attrs:{id:"更新配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#更新配置"}},[s._v("#")]),s._v(" 更新配置")]),s._v(" "),a("p",[s._v("如果你使用了不同的方式来安装 zookeeper，请确保更新存储配置文件 "),a("code",[s._v("config.json")]),s._v(" 中\n的 zookeeper 连接字符串和服务器配置文件"),a("code",[s._v("hstream-server.yaml")]),s._v("。")]),s._v(" "),a("p",[s._v("它应该看起来像这样：")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" config.json "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" -A "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" zookeeper\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"zookeeper"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"zookeeper_uri"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ip://zookeeper-0.zookeeper-headless:2181,zookeeper-1.zookeeper-headless:2181,zookeeper-2.zookeeper-headless:2181"')]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"timeout"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"30s"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" hstream-server.yaml "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" -A "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" zkuri\n            - "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"--zkuri"')]),s._v("\n            - "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"zookeeper-0.zookeeper-headless:2181,zookeeper-1.zookeeper-headless:2181,zookeeper-2.zookeeper-headless:2181"')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),a("p",[s._v("Storage 配置文件和服务文件中的 zookeeper 连接字符串可以是不同的。但对于正常情况\n下，它们是一样的。")])]),s._v(" "),a("p",[s._v("在默认情况下。本规范安装了一个 3 个节点的 HStream 服务器集群和 4 个节点的存储集\n群。如果你想要一个更大的集群，修改 "),a("code",[s._v("hstream-server.yaml")]),s._v(" 和\n"),a("code",[s._v("logdevice-statefulset.yaml")]),s._v(" 文件，并将复制的数量增加到你想要的集群中的节点数。\n另外，默认情况下，我们给节点附加一个 40GB 的持久性存储，如果你想要更多，你可以在\nvolumeClaimTemplates 部分进行修改。")]),s._v(" "),a("h3",{attrs:{id:"启动集群"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#启动集群"}},[s._v("#")]),s._v(" 启动集群")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("kubectl apply -k "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("当你运行"),a("code",[s._v("kubectl get pods")]),s._v("时，你应该看到类似如下：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("NAME                                                 READY   STATUS    RESTARTS   AGE\nhstream-server-deployment-765c84c489-94nqd           1/1     Running   0          6d18h\nhstream-server-deployment-765c84c489-jrm5p           1/1     Running   0          6d18h\nhstream-server-deployment-765c84c489-jxsjd           1/1     Running   0          6d18h\nlogdevice-0                                          1/1     Running   0          6d18h\nlogdevice-1                                          1/1     Running   0          6d18h\nlogdevice-2                                          1/1     Running   0          6d18h\nlogdevice-3                                          1/1     Running   0          6d18h\nlogdevice-admin-server-deployment-5c5fb9f8fb-27jlk   1/1     Running   0          6d18h\nzookeeper-0                                          1/1     Running   0          6d22h\nzookeeper-1                                          1/1     Running   0          10d\nzookeeper-2                                          1/1     Running   0          6d\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("h3",{attrs:{id:"bootstrap-存储集群"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#bootstrap-存储集群"}},[s._v("#")]),s._v(" Bootstrap 存储集群")]),s._v(" "),a("p",[s._v("一旦所有的 logdevice pods 运行并准备就绪，你将需要 Bootstrap 集群以启用所有的节\n点。要做到这一点，请运行：")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("kubectl run hstream-admin -it --rm --restart"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Never --image"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("hstreamdb/hstream:v0.9.0 -- "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    hadmin store --host logdevice-admin-server-service "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    nodes-config "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    bootstrap --metadata-replicate-across "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'node:3'")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("这将启动一个 hstream-admin pod，它连接到管理服务器并调用 "),a("code",[s._v("nodes-config bootstrap")]),s._v("\nhadmin store 命令，并将集群的元数据复制属性设置为跨三个不同的节点进行复制。")]),s._v(" "),a("p",[s._v("成功后，你应该看到类似如下：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('Successfully bootstrapped the cluster\npod "hstream-admin" deleted\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h2",{attrs:{id:"管理存储集群"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#管理存储集群"}},[s._v("#")]),s._v(" 管理存储集群")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("kubectl run hstream-admin -it --rm --restart"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Never --image"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("hstreamdb/hstream:v0.9.0 -- "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("现在你可以运行 "),a("code",[s._v("hadmin store")]),s._v(" 来管理这个集群：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("hadmin store --help\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("要检查集群的状态，你可以运行：")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("hadmin store --host logdevice-admin-server-service status\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("+----+-------------+-------+---------------+\n| ID |    NAME     | STATE | HEALTH STATUS |\n+----+-------------+-------+---------------+\n| 0  | logdevice-0 | ALIVE | HEALTHY       |\n| 1  | logdevice-1 | ALIVE | HEALTHY       |\n| 2  | logdevice-2 | ALIVE | HEALTHY       |\n| 3  | logdevice-3 | ALIVE | HEALTHY       |\n+----+-------------+-------+---------------+\nTook 2.567s\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])])])}),[],!1,null,null,null);e.default=t.exports}}]);